// ==================== C·∫§U H√åNH ====================
const urlParams = new URLSearchParams(window.location.search);
const canDelete = urlParams.get("key") === managerSignatureKey;

let selectedSignature = null;
let longPressTimer = null;
let longPressFired = false;

// ==================== T·∫†O N√öT L∆ØU V·ªä TR√ç (JS) ====================
function createSaveButton() {
    if (document.getElementById("savePositionBtn")) return; // tr√°nh t·∫°o l·∫ßn 2

    const btn = document.createElement("button");
    btn.id = "savePositionBtn";
    btn.textContent = "L∆∞u v·ªã tr√≠";
    btn.classList.add("hidden");
    document.body.appendChild(btn);

    const style = document.createElement("style");
    style.textContent = `
        #savePositionBtn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 30px;
            font-size: 18px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            z-index: 2000;
        }
        #savePositionBtn.hidden { display: none; }
        #savePositionBtn:hover { background-color: #0056b3; }
    `;
    document.head.appendChild(style);

    btn.addEventListener("click", () => {
        if (!selectedSignature) return;
        const signatureId = selectedSignature.dataset.id;
        // style.left is like "10%" -> parseFloat works
        const x = parseFloat(selectedSignature.style.left);
        const y = parseFloat(selectedSignature.style.top);

        // G·ª≠i request c·∫≠p nh·∫≠t v·ªã tr√≠
        fetch(libraryURL + "save_signature.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: signatureId, pos_x: x, pos_y: y, update_position: true })
        })
            .then(async r => {
                let data;
                try { data = await r.json(); } catch (err) { throw new Error("Ph·∫£n h·ªìi kh√¥ng h·ª£p l·ªá"); }
                if (data.success) {
                    alert("ƒê√£ l∆∞u v·ªã tr√≠ m·ªõi!");
                    btn.classList.add("hidden");
                    // t·∫Øt vi·ªÅn xanh v√† h·ªßy selection
                    if (selectedSignature) {
                        selectedSignature.style.border = "";
                        selectedSignature = null;
                    }
                } else {
                    throw new Error(data.error || "L∆∞u th·∫•t b·∫°i");
                }
            })
            .catch(err => {
                console.error("L·ªói khi l∆∞u v·ªã tr√≠:", err);
                alert("L∆∞u v·ªã tr√≠ th·∫•t b·∫°i: " + (err.message || err));
            });
    });
}
createSaveButton();

// ==================== H√ÄM LOAD CH·ªÆ K√ù ====================
function loadSignatures(idUser, userCard, sizeSig) {
    fetch(libraryURL + `get_signatures.php?idUser=${encodeURIComponent(idUser)}&userCard=${encodeURIComponent(userCard)}`)
        .then(response => response.json())
        .then(signatures => {
            if (signatures.error) {
                console.error("L·ªói t·ª´ PHP:", signatures.error);
                return;
            }

            const container = document.getElementById("previewContainer");
            container.innerHTML = "";

            signatures.forEach(sig => {
                const img = document.createElement("img");
                img.src = libraryURL + sig.image_path;
                img.alt = `Ch·ªØ k√Ω c·ªßa ${sig.user_card}`;
                img.dataset.id = sig.id;
                img.classList.add("signature-img");
                img.style.width = sizeSig + "%";
                img.style.position = "absolute";
                img.style.top = sig.pos_y + "%";
                img.style.left = sig.pos_x + "%";
                img.dataset.ip = sig.ip;
                img.setAttribute("draggable", "false");

                if (canDelete) {
                    enableSignatureEvents(img);
                } else {
                    img.style.cursor = "default";
                }

                container.appendChild(img);
            });
        })
        .catch(error => console.error("L·ªói khi t·∫£i ch·ªØ k√Ω:", error));
}

// ==================== S·ª∞ KI·ªÜN: pointer (mouse + touch) + drag + long-press ====================
function enableSignatureEvents(img) {
    const container = document.getElementById("previewContainer");
    img.style.touchAction = "none"; // tr√°nh h√†nh vi scroll m·∫∑c ƒë·ªãnh tr√™n touch
    img.style.cursor = "grab";

    let startX = 0, startY = 0;
    let startImgLeft = 0, startImgTop = 0;
    let isDragging = false;
    let pointerId = null;

    function clampToContainer(leftPx, topPx, imgRect, containerRect) {
        const maxLeft = Math.max(0, containerRect.width - imgRect.width);
        const maxTop = Math.max(0, containerRect.height - imgRect.height);
        const clampedLeft = Math.min(Math.max(0, leftPx), maxLeft);
        const clampedTop = Math.min(Math.max(0, topPx), maxTop);
        return {
            leftPercent: (clampedLeft / containerRect.width) * 100,
            topPercent: (clampedTop / containerRect.height) * 100
        };
    }

    function onPointerDown(e) {
        // ch·ªâ handle primary pointer
        if (pointerId !== null) return;
        pointerId = e.pointerId;
        img.setPointerCapture && img.setPointerCapture(pointerId);

        e.preventDefault();

        const rect = img.getBoundingClientRect();
        const containerRect = container.getBoundingClientRect();

        startX = e.clientX;
        startY = e.clientY;
        startImgLeft = rect.left - containerRect.left; // px relative to container
        startImgTop = rect.top - containerRect.top;

        isDragging = false;
        longPressFired = false;

        // Set selection + green border immediately
        if (selectedSignature && selectedSignature !== img) {
            selectedSignature.style.border = "";
        }
        selectedSignature = img;
        img.style.border = "2px solid green"; // vi·ªÅn xanh
        document.getElementById("savePositionBtn").classList.remove("hidden");

        // Long press timer
        longPressTimer = setTimeout(() => {
            longPressFired = true;
            img.style.border = "2px solid red";
            document.getElementById("deleteDialog").style.display = "block";
        }, 1000);

        document.addEventListener("pointermove", onPointerMove);
        document.addEventListener("pointerup", onPointerUp);
        document.addEventListener("pointercancel", onPointerCancel);
    }

    function onPointerMove(e) {
        if (e.pointerId !== pointerId) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        const dist = Math.sqrt(dx * dx + dy * dy);

        // N·∫øu di chuy·ªÉn v∆∞·ª£t ng∆∞·ª°ng -> b·∫Øt ƒë·∫ßu drag v√† hu·ª∑ long press
        if (!isDragging && dist > 6) {
            isDragging = true;
            clearTimeout(longPressTimer);
            longPressTimer = null;
            img.style.cursor = "grabbing";
        }

        if (isDragging) {
            const containerRect = container.getBoundingClientRect();
            const imgRect = img.getBoundingClientRect();

            let newLeftPx = startImgLeft + (e.clientX - startX);
            let newTopPx = startImgTop + (e.clientY - startY);

            const { leftPercent, topPercent } = clampToContainer(newLeftPx, newTopPx, imgRect, containerRect);
            img.style.left = leftPercent + "%";
            img.style.top = topPercent + "%";
        }
    }

    function onPointerUp(e) {
        if (e.pointerId !== pointerId) return;
        cleanupPointerListeners();

        // n·∫øu longPressTimer v·∫´n t·ªìn t·∫°i (ng∆∞·ªùi click v√† th·∫£ < 1s) -> n√≥ kh√¥ng ph·∫£i longPress -> ch·ªâ ch·ªçn (ƒë√£ set border xanh l√∫c down)
        clearTimeout(longPressTimer);
        longPressTimer = null;

        // reset cursor
        img.style.cursor = "move";
        pointerId = null;
        isDragging = false;
    }

    function onPointerCancel(e) {
        if (e.pointerId !== pointerId) return;
        cleanupPointerListeners();
    }

    function cleanupPointerListeners() {
        document.removeEventListener("pointermove", onPointerMove);
        document.removeEventListener("pointerup", onPointerUp);
        document.removeEventListener("pointercancel", onPointerCancel);
        try { img.releasePointerCapture && img.releasePointerCapture(pointerId); } catch (err) { }
        clearTimeout(longPressTimer);
        longPressTimer = null;
        pointerId = null;
    }

    // B·ªï sung: n·∫øu ng∆∞·ªùi h·ªßy (escape ho·∫∑c click v√†o v√πng kh√°c), gi·ªØ nguy√™n logic h·ªßy
    img.addEventListener("pointerdown", onPointerDown);
}

// ==================== X√ìA CH·ªÆ K√ù ====================
document.getElementById("confirmDelete").addEventListener("click", () => {
    if (!selectedSignature || !canDelete) {
        alert("Kh√¥ng c√≥ ch·ªØ k√Ω n√†o ƒë∆∞·ª£c ch·ªçn ho·∫∑c b·∫°n kh√¥ng c√≥ quy·ªÅn x√≥a.");
        return;
    }

    const signatureId = selectedSignature.dataset.id;
    if (!signatureId) {
        alert("L·ªói: Kh√¥ng l·∫•y ƒë∆∞·ª£c ID ch·ªØ k√Ω!");
        return;
    }

    fetch(libraryURL + "delete_signature.php", {
        method: "POST",
        body: JSON.stringify({ id: signatureId }),
        headers: { "Content-Type": "application/json" }
    })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert("Ch·ªØ k√Ω ƒë√£ ƒë∆∞·ª£c x√≥a!");
                selectedSignature.remove();
                selectedSignature = null;
                document.getElementById("deleteDialog").style.display = "none";
                // ·∫©n n√∫t l∆∞u n·∫øu hi·ªÉn th·ªã
                const btn = document.getElementById("savePositionBtn");
                if (btn) btn.classList.add("hidden");
            } else {
                alert("L·ªói khi x√≥a: " + data.error);
            }
        })
        .catch(error => {
            console.error("L·ªói khi x√≥a ch·ªØ k√Ω:", error);
            alert("L·ªói khi x√≥a ch·ªØ k√Ω.");
        });
});

// H·ªßy x√≥a popup
document.getElementById("cancelDelete").addEventListener("click", () => {
    document.getElementById("deleteDialog").style.display = "none";
    if (selectedSignature) {
        selectedSignature.style.border = "";
        selectedSignature = null;
    }
});



// ==================== TH√äM N√öT CH·∫∂N + CSS B·∫∞NG JS ====================
function addButtonBlockIP() {
    const dialog = document.querySelector("#deleteDialog");
    if (!dialog) return;

    // t·∫°o n√∫t Ch·∫∑n IP
    const blockBtn = document.createElement("button");
    blockBtn.id = "blockIP";
    blockBtn.textContent = "Ch·∫∑n ch·ªØ k√Ω t·ª´ ng∆∞·ªùi n√†y";
    blockBtn.className = "btn btn-warning"; // style t√πy b·∫°n

    // t√¨m n√∫t H·ªßy
    const cancelBtn = dialog.querySelector("#cancelDelete");

    if (cancelBtn) {
        const parent = cancelBtn.parentNode; // l·∫•y ƒë√∫ng parent c·ªßa n√∫t H·ªßy
        if (parent) {
            parent.insertBefore(blockBtn, cancelBtn); // ch√®n tr∆∞·ªõc n√∫t H·ªßy
        } else {
            dialog.appendChild(blockBtn); // fallback n·∫øu parent null
        }
    } else {
        dialog.appendChild(blockBtn); // fallback n·∫øu kh√¥ng t√¨m th·∫•y n√∫t H·ªßy
    }

    // CSS
    const style = document.createElement("style");
    style.textContent = `
        #deleteDialog button {
            display: block;
            width: 80%;
            margin: 8px auto;
            padding: 12px 20px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        #confirmDelete { background: #dc3545; color: #fff; }
        #blockIP      { background: #f0ad4e; color: #fff; }
        #cancelDelete { background: #6c757d; color: #fff; }
    `;
    document.head.appendChild(style);

    blockBtn.addEventListener("click", () => {
        if (!selectedSignature) return alert("Ch∆∞a ch·ªçn ch·ªØ k√Ω n√†o!");

        const ip = selectedSignature.dataset.ip;
        const signatureId = selectedSignature.dataset.id;
        if (!signatureId) return alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c ch·ªØ k√Ω!");

        fetch(libraryURL + "block_ip.php", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: signatureId })   // üîπ g·ª≠i id
        })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert("ƒê√£ ch·∫∑n ch·ªØ k√Ω t·ª´ ng∆∞·ªùi n√†y");
                    dialog.style.display = "none";
                } else {
                    alert("Ch·∫∑n l·ªói: " + data.error);
                }
            })
            .catch(err => {
                console.error("L·ªói ch·∫∑n:", err);
                alert("C√≥ l·ªói k·∫øt n·ªëi khi ch·∫∑n");
            });
    });

}
document.addEventListener("DOMContentLoaded", addButtonBlockIP);

